{% load static %}

{% include 'header.html' %}
<head>
    <link rel="stylesheet" type="text/css" href="{% static 'css/mystyle.css' %}" media="all">
    <link rel="stylesheet" type="text/css" href="{% static 'css/checkbox.css' %}" media="all">
    
</head>

<script type="text/javascript">

$(document).ready(function(){
    $('#subquery').click(function(){
        
        var publish_date_start = document.getElementById("publish_date_start").value;
        var publish_date_end = document.getElementById("publish_date_end").value;
        var select = document.getElementById("select").value;
        var vacancies = document.getElementById("vacancies").value;

        $.ajax({
            url:"{% url 'subquery_vacancy_admin' %}",
            data :  {

                publish_date_start,
                publish_date_end,
                select,
                vacancies,

                csrfmiddlewaretoken: '{{ csrf_token }}'
            },
            type:'POST',

            datatype : 'text',

                                
            success:function(data){
                $('#vacancy_list_admin_table').html('');
                $('#vacancy_list_admin_table').html(data);
                $('#vacancy_list_admin').DataTable({
                    "order": [[ 3, "desc" ]],
                    "lengthChange": false,
                    "bInfo" : false,
                    "language": {
                        "paginate": {
                            "previous": "上一頁",
                            "next": "下一頁",
                        },
                        "search": "搜尋表格:"
                    }
                });
            },
                                        
            beforeSend:function(){

                $.blockUI({ css: { 
                            width : '25%',
                            border: 'none', 
                            padding: '15px', 
                            backgroundColor: '#000', 
                            '-webkit-border-radius': '10px', 
                            '-moz-border-radius': '10px', 
                            opacity: .5, 
                            color: '#fff'
                            }
                         });
            },

            complete:function(){
                $.unblockUI();
            },        
            error:function(xhr, ajaxOptions, thrownError){ 
                alert(xhr.status); 
                alert(thrownError);
            }       
        });                                                                                                           
    })

    $('#del_vacancy').click(function(){
        
        // var select = document.getElementById("select").value;
        var file = [];
        $('input:checkbox:checked[name="company_checkbox"]').each(function (i) {
            file[i] = this.value;      
        });

        $.ajax({
            url:"{% url 'del_vacancy' %}",
            data :  {
                'file[]':file,
                'page' : "{{ page }}",
                csrfmiddlewaretoken: '{{ csrf_token }}'
            },
            type:'POST',

            datatype : 'text',

                                
            success:function(data){
                $('#company_list_table').html('');
                $('#company_list_table').html(data);
                // $('#vacancy_list_admin').DataTable({
                //     "order": [[ 3, "desc" ]],
                //     "lengthChange": false,
                //     "bInfo" : false,
                //     "language": {
                //         "paginate": {
                //             "previous": "上一頁",
                //             "next": "下一頁",
                //         }
                //     }
                // });
                window.location.href = "{% url 'Vacancy_M_admin' %}";
                },
                                        
            beforeSend:function(){

                $.blockUI({ css: { 
                            width : '25%',
                            border: 'none', 
                            padding: '15px', 
                            backgroundColor: '#000', 
                            '-webkit-border-radius': '10px', 
                            '-moz-border-radius': '10px', 
                            opacity: .5, 
                            color: '#fff'
                            }
                         });
            },

            complete:function(){
                $.unblockUI();
            },        
            error:function(xhr, ajaxOptions, thrownError){ 
                alert(xhr.status); 
                alert(thrownError);
            }       
        });                                                                                                           
    });

    $('#C_V_log_download').click(function(){

        var download_data_type = document.getElementById("download_select1").value;
        var publish_date_start_download = document.getElementById("publish_date_start_download").value;
        var publish_date_end_download = document.getElementById("publish_date_end_download").value;
        var record_type1 = document.getElementById("download_select2").value;
        var record_type2 = document.getElementById("download_select3").value;

        $.ajax({
            url:"{% url 'C_V_log_download' %}",
            data :  {

                download_data_type,
                publish_date_start_download,
                publish_date_end_download,
                record_type1,
                record_type2,

                csrfmiddlewaretoken: '{{ csrf_token }}'
            },
            type:'POST',

            datatype : 'text',

                                
            success:function(data){
                // $('#vacancy_list_admin_table').html('');
                // $('#vacancy_list_admin_table').html(data);
                // console.log(data.company_name_C)
                window.location.href = "{% url 'download' %}?folder=download&filename="+data.file_name
            },
                                        
            beforeSend:function(){

                $.blockUI({ css: { 
                            width : '25%',
                            border: 'none', 
                            padding: '15px', 
                            backgroundColor: '#000', 
                            '-webkit-border-radius': '10px', 
                            '-moz-border-radius': '10px', 
                            opacity: .5, 
                            color: '#fff'
                            }
                         });
            },

            complete:function(){
                $.unblockUI();
            },        
            error:function(xhr, ajaxOptions, thrownError){ 
                alert(xhr.status); 
                alert(thrownError);
            }       
        });                                                                                                           
    })

    $("#select").select2({
        placeholder: "請選擇",
        allowClear: true
    });

    $("#download_select1").select2({
        placeholder: "請選擇",
        allowClear: true
    });

    $("#pre_select").select2({
        placeholder: "請先選擇資料類別",
        allowClear: true
    });

    $("#download_select2").select2({
        placeholder: "請選擇",
        allowClear: true
    });

    $("#download_select3").select2({
        placeholder: "請選擇",
        allowClear: true
    });

    $('#vacancy_list_admin').DataTable({
        "order": [[ 3, "desc" ]],
        "lengthChange": false,
        "bInfo" : false,
        "language": {
            "paginate": {
                "previous": "上一頁",
                "next": "下一頁",
            },
            "search": "搜尋表格:"
        }
    });

    $('#del_vacancy_pre').click(function(){
        $("#modal_del_confirm").modal('show');
    })

    $('#del_vacancy').click(function(){
        $("#modal_del_confirm").modal('hide');
    })

    $("#checkall").click(function(){
        $('input:checkbox').not(this).prop('checked', this.checked);
    });

    var dateToday = new Date(); 
    $('#publish_date_start').datepicker({
        dateFormat: 'yy/mm/dd',
        numberOfMonths: 2,
        // minDate: dateToday,
    });

    $('#publish_date_end').datepicker({
        dateFormat: 'yy/mm/dd',
        numberOfMonths: 2,
        // minDate: dateToday
    });

    $('#publish_date_start_download').datepicker({
        dateFormat: 'yy/mm/dd',
        numberOfMonths: 2,
        // minDate: dateToday,
    });

    $('#publish_date_end_download').datepicker({
        dateFormat: 'yy/mm/dd',
        numberOfMonths: 2,
        // minDate: dateToday
    });

    $('#C_V_log_download_pre').click(function(){
        if($("#C_V_log_download_pre").hasClass( "active" )){
            $('#C_V_log_download_pre').removeClass("active");
            $('#vacancy_download').hide(250);
        }
        else{
            $('#C_V_log_download_pre').addClass("active");
            $('#vacancy_download').show(250);
        }
    })

    $('#C_V_filter').change(function(){
        var download_select1 = $("#download_select1").val()
        $("#download_select2").val('')
        $("#download_select3").val('')
        if(download_select1 == "company_data_download"){
            $("#company_filter").show();
            $("#vacancy_filter").hide();
            $("#pre_filter").hide();
        }
        else{
            $("#company_filter").hide();
            $("#vacancy_filter").show();
            $("#pre_filter").hide();
        }
    });
});
</script>

<div id="id_content">
    <div id = "middle">
        <div width=100% align="center">

            <div id="Sidebar_middle">
	            <ul class="nav nav-tabs">
	                <li>
                        <a href="{% url 'Company_info_admin' %}" style="background-color:#fcfcfc;border-top:2px solid #1982b8;font-weight:bold;">企業基本資料管理</a>
                    </li>
                    <li>
                        <a href="{% url 'Vacancy_M_admin' %}" style="background-color:#fcfcfc;border-top:2px solid #1982b8;font-weight:bold;">刊登職缺管理</a>
                    </li>
	            </ul>
	            <form class="form-horizontal SearchForm">
	                <br><br>
    	            <ul class="nav nav-tabs" style="padding-left: 70px;">
	                	<li><a style="background-color:#fcfcfc;border-bottom:2px solid #B22222;font-weight:bold;box-shadow:5px 5px 8px 2px #ccc;">職缺管理</a></li>
	            	</ul><br>
				 	<div class='FormOption'>
                        <div class="form-group">
	                            
                            <label for="inputPassword3" class="col-sm-3 control-label">刊登日期 (起) : </label>

                            <div class="col-sm-6">
                                <div class="input-group">
                                    <input type='text' class="form-control" id="publish_date_start">
                                    <span class="input-group-addon">
                                        <span class="glyphicon glyphicon-calendar" aria-hidden="true"></span>
                                    </span>
                                </div>
                            </div><br><br>

                            <label for="inputPassword3" class="col-sm-3 control-label">刊登日期 (迄) : </label>

                            <div class="col-sm-6">
                                <div class="input-group">
                                    <input type='text' class="form-control" id="publish_date_end">
                                    <span class="input-group-addon">
                                        <span class="glyphicon glyphicon-calendar" aria-hidden="true"></span>
                                    </span>
                                </div>
                            </div><br><br>

                            <label for="inputPassword3" class="col-sm-3 control-label">刊登狀態 : </label>

                            <div class="col-sm-6">
                                <select class="form-control" id = 'select' style='width: 100%'>
                                    <option></option>
                                    <option value='ALL'>ALL</option>
                                    <option value='true'>已刊登</option>
                                    <option value='false'>未刊登</option>
                                </select>
                            </div><br><br>

                            <label for="inputPassword3" class="col-sm-3 control-label">職缺項目 : </label>

                            <div class="col-sm-6">
						    	<input type="text" class="form-control" placeholder="" id="vacancies">
                            </div><br><br>

                        </div>
                        <button type ='button' id = "subquery" class="btn btn-primary">查詢</button><br><br>
                    </div><br><br>

                    <div align="left" style="padding-left:70px;">

                    <button type ='button' id = "del_vacancy_pre" class="btn btn-primary">刪除已勾選職缺</button>
                    <button type ='button' id = "C_V_log_download_pre" class="btn btn-primary">下載職缺紀錄</button><br>
                    </div>

                    <div style='display:none;' id="vacancy_download"><br>
                    <div class='FormOption'>
                        <div class="form-group">
                            
                            <label for="inputPassword3" class="col-sm-3 control-label">資料類別: </label>

                            <div class="col-sm-6" id ="C_V_filter">
                                <select class="form-control" id = 'download_select1' style='width: 100%'>
                                    <option></option>

                                    <option value='company_data_download'>廠商資料</option>
                                    <option value='vacancy_data_download'>職缺資料</option>
                                </select>
                            </div><br><br>

                            <label for="inputPassword3" class="col-sm-3 control-label">日期 (起) : </label>

                            <div class="col-sm-6">
                                <div class="input-group">
                                    <input type='text' class="form-control" id="publish_date_start_download">
                                    <span class="input-group-addon">
                                        <span class="glyphicon glyphicon-calendar" aria-hidden="true"></span>
                                    </span>
                                </div>
                            </div><br><br>

                            <label for="inputPassword3" class="col-sm-3 control-label">日期 (迄) : </label>

                            <div class="col-sm-6">
                                <div class="input-group">
                                    <input type='text' class="form-control" id="publish_date_end_download">
                                    <span class="input-group-addon">
                                        <span class="glyphicon glyphicon-calendar" aria-hidden="true"></span>
                                    </span>
                                </div>
                            </div><br><br>

                            <label for="inputPassword3" class="col-sm-3 control-label">紀錄類別 : </label>

                            <div class="col-sm-6" id ="pre_filter">
                                <select class="form-control" style='width: 100%' id="pre_select" disabled>
                                    <option></option>
                                </select>
                            </div>
                            <div class="col-sm-6" style="display:none" id = "company_filter">
                                <select class="form-control" id = 'download_select2' style='width: 100%'>
                                    <option></option>
                                    <option value='company_now_post'>現有刊登職缺紀錄</option>
                                    <option value='company_once_post'>曾有刊登職缺紀錄(含現有)</option>
                                    <option value='company_no_post'>無刊登職缺紀錄</option>
                                    <option value='company_all'>不分類匯出</option>
                                </select>
                            </div>
                            <div class="col-sm-6" style="display:none" id = "vacancy_filter">
                                <select class="form-control" id = 'download_select3' style='width: 100%'>
                                    <option></option>
                                    <option value='vacancy_now_post'>有效刊登職缺</option>
                                    <option value='vacancy_expired_post'>失效刊登職缺</option>
                                    <option value='vacancy_del_post'>被刪除之職缺</option>
                                </select>
                            </div><br><br>

                        </div>
                        <button type ='button' id = "C_V_log_download" class="btn btn-primary">下載</button><br><br>
                    </div><br>
                    </div>

                    <div style="width:90%;" id="vacancy_list_admin_table">
                        <table id="vacancy_list_admin">
                            <thead>
                                <tr>
                                    <th><input type="checkbox" id="checkall"></th>
                                    <th>公司名稱</th>
                                    <th>職稱項目</th>
                                    <th>刊登日期 (起)</th>
                                    <th>刊登日期 (迄)</th>
                                    <th>查詢</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% if result %}
                                    {% for row in result %}
                                        {% if row.19 == 'true' %}
                                            <tr style="background-color:#90EE90">
                                                <td style="padding:10px 18px;">
                                                    <input type="checkbox" name="company_checkbox" value="{{ row.1 }}|{{ row.2 }}|{{ row.3 }}|{{ row.17 }}|{{ row.18 }}">
                                                </td>
                                                <td>{{ row.1 }}</td>
                                                <td>{{ row.3 }}</td>
                                                <td>{{ row.17 }}</td>
                                                <td>{{ row.18 }}</td>
                                                <td><a href="{% url 'Vacancy_edit_page_admin' %}?company_name_C={{ row.1|urlencode }}&account={{ row.2|urlencode }}&vacancies={{ row.3|urlencode }}&work_place={{ row.4|urlencode }}&work_time={{ row.5|urlencode }}&treatment={{ row.6|urlencode }}&publish_date_start={{ row.17|urlencode }}&publish_date_end={{ row.18|urlencode }}">查詢</a></td>
                                            </tr>
                                        {% else %}
                                            <tr style="background-color:#DCDCDC">
                                                <td style="padding:10px 18px;">
                                                    <input type="checkbox" name="company_checkbox" value="{{ row.1 }}|{{ row.2 }}|{{ row.3 }}|{{ row.17 }}|{{ row.18 }}">
                                                </td>
                                                <td>{{ row.1 }}</td>
                                                <td>{{ row.3 }}</td>
                                                <td>{{ row.17 }}</td>
                                                <td>{{ row.18 }}</td>
                                                <td><a href="{% url 'Vacancy_edit_page_admin' %}?company_name_C={{ row.1|urlencode }}&account={{ row.2|urlencode }}&vacancies={{ row.3|urlencode }}&work_place={{ row.4|urlencode }}&work_time={{ row.5|urlencode }}&treatment={{ row.6|urlencode }}&publish_date_start={{ row.17|urlencode }}&publish_date_end={{ row.18|urlencode }}">查詢</a></td>
                                            </tr>
                                        {% endif %}
                                    {% endfor %}  
                                {% endif %}
                            </tbody>
                        </table><br>
                    </div>

                    <div class="modal fade" id="modal_del_confirm" role="dialog">
                        <div class="modal-dialog">
                          <!-- Modal content-->
                            <div class="modal-content">
                                <div class="modal-header">
                                    <button type="button" class="close" data-dismiss="modal">&times;</button>
                                    <h4 class="modal-title">請再次確認!</h4>
                                </div>
                            <div class="modal-body">
                                <p>確定刪除?</p>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-default" id="del_vacancy">刪除</button>
                                <button type="button" class="btn btn-default" data-dismiss="modal">關閉</button>
                            </div>
                            </div>
                        </div>
                    </div>
	            </form><br>
           	</div>
        </div>

        <div id = 'output'>
        </div>
    </div>
</div><br>


{% include 'footer.html' %}
